---
- name: Validate wordpress_sites
  fail:
    msg: "{{ lookup('template', 'wordpress_sites.j2') }}"
  when: wordpress_sites.keys() | difference(vault_wordpress_sites.keys()) | count
  tags: [wordpress]

- name: Validate format of site_hosts
  fail:
    msg: "{{ lookup('template', 'site_hosts.j2') }}"
  loop: "{{ wordpress_sites | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  when: item.value.site_hosts | rejectattr('canonical', 'defined') | list | count
  tags: [letsencrypt, wordpress]

- name: Import PHP version specific vars
  include_vars: "{{ lookup('first_found', params) }}"
  vars:
    params:
      files:
        - '{{ php_version }}.yml' # e.g. 8.2.yml
        - version-specific-defaults.yml
      paths:
        - "{{ playbook_dir }}/roles/php/vars/"

  tags: [memcached, php, sshd]

- name: Verify dict format for package component variables
  fail:
    msg: "{{ lookup('template', 'package_vars_wrong_format_msg.j2') }}"
  when: package_vars_wrong_format | count
  vars:
    package_vars:
      apt_packages_default: "{{ apt_packages_default }}"
      apt_packages_custom: "{{ apt_packages_custom }}"
      memcached_packages_default: "{{ memcached_packages_default }}"
      memcached_packages_custom: "{{ memcached_packages_custom }}"
      php_extensions_default: "{{ php_extensions_default }}"
      php_extensions_custom: "{{ php_extensions_custom }}"
      sshd_packages_default: "{{ sshd_packages_default }}"
      sshd_packages_custom: "{{ sshd_packages_custom }}"
    package_vars_wrong_format: "[{% for k,v in package_vars.items() | list if v | type_debug != 'dict' %}'{{ k }}',{% endfor %}]"
  tags: [memcached, php, sshd]

- name: Verify dict format for package combined variables
  fail:
    msg: "{{ lookup('template', 'package_vars_wrong_format_msg.j2') }}"
  when: package_vars_wrong_format | count
  vars:
    package_vars:
      apt_packages: "{{ apt_packages }}"
      memcached_packages: "{{ memcached_packages }}"
      php_extensions: "{{ php_extensions }}"
      sshd_packages: "{{ sshd_packages }}"
    package_vars_wrong_format: "[{% for k,v in package_vars.items() | list if v | type_debug != 'dict' %}'{{ k }}',{% endfor %}]"
  tags: [memcached, php, sshd]

- name: Clean old APT sources
  import_tasks: clean-apt-sources.yml
  when: apt_clean_sources | default(false)

- name: Update apt packages
  apt:
    update_cache: yes

- name: Checking essentials
  apt:
    name: "{{ item.key }}"
    state: "{{ item.value }}"
    cache_valid_time: "{{ apt_cache_valid_time }}"
  loop: "{{ apt_packages | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

- name: Add myhostname to nsswitch.conf to ensure resolvable hostname
  lineinfile:
    backrefs: yes
    backup: yes
    dest: /etc/nsswitch.conf
    line: \1 myhostname
    regexp: ^(hosts\:((?!myhostname).)*)$
    state: present

- block:
    - name: Retrieve SSH client IP
      ipify_facts:
      delegate_to: localhost
      become: no
      when: env != 'development' and ssh_client_ip_lookup | default(true)
      tags: [fail2ban, ferm]
  rescue:
    - name: Fail when unable to retrieve SSH client IP
      fail:
        msg: "External IP resolution failed. Check that your DNS servers are working. Try to disable DNSCrypt if you are using it."

- name: Restrict journal log size
  lineinfile:
    backup: yes
    dest: /etc/systemd/journald.conf
    insertafter: "^[Journal]"
    line: "SystemMaxUse={{ max_journal_size }}"
    regexp: "^#?(SystemMaxUse=.*?)$"
    state: present
  notify: restart journald
